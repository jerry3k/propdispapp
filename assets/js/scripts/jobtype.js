// This file is generated by Nasir Scripts
var Page = 1;
var Rows = '';
var is_loading = true;
$( function() {
	load_data();

	$( document ).on( 'click', '.add', function( e ) {
		e.preventDefault();
		$( '#add_job_type' ).modal( 'show' );
		$( "#form1 input[name=id]" ).val( '0' );
		$( '#form1 #btn_reset' ).trigger( 'click' );
		$( "#form1 input[name=print_name][type=checkbox]" ).attr( 'checked', false ).uniform();
		$( "#form1 input[name=position][type=checkbox]" ).attr( 'checked', false ).uniform();
	} );

	// form1 submit
	$( document ).on( 'submit', '#form1', function( e ) {
		e.preventDefault();
		Block( 'add_job_type' );
		$( '#form1' ).ajaxSubmit( {
			success: function( data ) {
				UnBlock( 'add_job_type' );
				if ( data.substr( 0, 2 ) == 'OK' ) {
					$( '#add_job_type' ).modal( 'hide' );
					let id = $( "#form1 input[name=id]" ).val();
					if ( empty( id ) ) {
						id = data.substr( 3 );
						if ( empty( id ) ) {
							load_data();
						} else {
							append_data( id );
						}
						Success( 'Saved successfully.' );
					} else {
						load_rows( id );
						Success( 'Updated successfully.' );
					}
				} else {
					Error( data );
				}
			},
		} );
	} );

	$( document ).on( 'click', '.edit', function( e ) {
		e.preventDefault();
		let id = $( this ).attr( 'data-id' );
		Block();
		$.ajax( {
			method: 'post',
			url: DOMAIN_URL + 'jobtype/load_data',
			data: { id: id },
			success: function( data ) {
				UnBlock();
				if ( !empty( data.rows ) ) {
					let row = data.rows[ 0 ];
					$( '#add_job_type' ).modal( 'show' );
					//
					$( "#form1 input[name=id]" ).val( id );
					$( "#form1 input[name=name]" ).val( row.name );
					$( "#form1 input[name=price_a]" ).val( row.price_a );
					$( "#form1 input[name=price_b]" ).val( row.price_b );
					$( "#form1 input[name=discount]" ).val( row.discount );
					$( "#form1 textarea[name=description]" ).val( row.description );

					if ( !empty( row.print_name ) && row.print_name == 'Y' ) {
						$( "#form1 input[name=print_name][type=checkbox]" ).attr( 'checked', true ).uniform();
					} else {
						$( "#form1 input[name=print_name][type=checkbox]" ).attr( 'checked', false ).uniform();
					}

					if ( !empty( row.position ) && row.position == 'Y' ) {
						$( "#form1 input[name=position][type=checkbox]" ).attr( 'checked', true ).uniform();
					} else {
						$( "#form1 input[name=position][type=checkbox]" ).attr( 'checked', false ).uniform();
					}

				} else {
					Error( data );
				}
			}
		} );
	} );

	// search shop data
	$( document ).on( 'keypress', '#filter_search', function( e ) {
		if ( e.which == 13 ) {
			Page = 1;
			$( '#page' ).val( '1' );
			$( '#order' ).val( 'ASC' );
			Block();
			$.ajax( {
				method: 'post',
				url: DOMAIN_URL + 'jobtype/load_data',
				data: $( '.form-filter' ).serialize(),
				success: function( data ) {
					UnBlock();
					Rows = data;
					make_html();
					$( "#temp_row" ).remove();
				}
			} );
		}
	} );

	// Delete shop data
	$( document ).on( 'click', '.delete', function( e ) {
		e.preventDefault();
		if ( !confirm( 'Are you sure you want to delete this job type...?' ) ) {
			return false;
		}
		let id = $( this ).attr( 'data-id' );
		loading( 'row_id_' + id );
		$.ajax( {
			url: DOMAIN_URL + 'jobtype/delete',
			method: 'post',
			data: { id: id },
			success: function( d ) {
				unloading( 'row_id_' + id );
				if ( d == 'OK' ) {
					$( '#row_id_' + id ).remove();
				} else {
					Error( d );
				}
			}
		} )
	} );

	// Reset search
	$( document ).on( 'click', '.reset_search', function( e ) {
		e.preventDefault();
		Page = 1;
		$( '#page' ).val( '1' );
		$( '#order' ).val( 'ASC' );
		$( '#filter_search' ).val( '' );
		$( '#tbody' ).unmark( markjs_options );
		load_data();
	} );

	window.addEventListener( "wheel", function( e ) {
		if ( Page >= Rows.pages ) {
			return false;
		}
		let windowHeight = $( window ).height();
		let windowScrooll = $( window ).scrollTop();
		let documentHeight = $( document ).height();
		console.log( windowScrooll );
		if ( Page < Rows.pages && !is_loading && windowHeight + windowScrooll >= documentHeight - 400 ) { //if user scrolled to bottom of the page
			Page++;
			is_loading = true;
			$( '#page' ).val( Page );

			if ( Page > 1 ) {
				$( "#tbody" ).append( "<tr id='temp_row'><td class='center' colspan='7'><i class='fa fa-spin fa-spinner'></i> Loading ....</td></tr>" );
			}

			load_data();
		}
	} );
	// window scroll pagenation
	$( document ).on( 'scroll', function() {
		if ( Page >= Rows.pages ) {
			return false;
		}
		if ( Page < Rows.pages && !is_loading && $( window ).scrollTop() + $( window ).height() >= $( document ).height() - 400 ) { //if user scrolled to bottom of the page
			Page++;
			is_loading = true;
			$( '#page' ).val( Page );
			if ( Page > 1 ) {
				$( "#tbody" ).append( "<tr id='temp_row'><td class='center' colspan='7'><i class='fa fa-spin fa-spinner'></i> Loading ....</td></tr>" );
			}
			load_data();
		}
	} );

	// User status change
	$( document ).on( 'click', '.status', function( e ) {
		e.preventDefault();
		let id = $( this ).attr( 'data-id' );
		let status = $( this ).attr( 'data-status' );
		loading( 'row_id_' + id );
		$.ajax( {
			url: DOMAIN_URL + 'jobtype/status',
			method: 'post',
			data: { id: id, status: status },
			success: function( data ) {
				unloading( 'row_id_' + id );
				if ( data == 'OK' ) {
					Success( 'Status updated.' );
					load_rows( id );
				} else {
					Error( data );
				}
			}
		} );
	} );

} );

function load_data() {
	if ( Page == 1 ) {
		Block();
	}
	$.ajax( {
		url: DOMAIN_URL + 'jobtype/load_data',
		method: 'post',
		data: $( '.form-filter' ).serialize(),
		success: function( data ) {
			UnBlock();
			Rows = data;
			make_html();
			$( "#temp_row" ).remove();
		}
	} );
}

function make_html() {
	$( "#total_records" ).html( Rows.total_records );
	HTML = tmpl( 'load_data', Rows.rows );
	if ( Page > 1 ) {
		$( "#tbody" ).append( HTML );
	} else {
		$( "#tbody" ).html( HTML );
	}
	is_loading = false;
	if ( isset( $( '#filter_search' ).val() ) && $( '#filter_search' ).val() != '' ) {
		$( '#tbody' ).mark( $( '#filter_search' ).val(), markjs_options );
	}
	UnBlock();
}

function load_rows( id = '' ) {
	if ( empty( id ) ) {
		return false;
	}
	loading( 'row_id_' + id );
	$.ajax( {
		url: DOMAIN_URL + 'jobtype/load_data',
		method: 'post',
		data: { id: id },
		success: function( data ) {
			unloading( 'row_id_' + id );
			$( '#row_id_' + id ).html( tmpl( 'load_row', data.rows ) );
		}
	} );
}

function append_data( id = '' ) {
	if ( empty( id ) ) {
		return false;
	}
	Block();
	$.ajax( {
		url: DOMAIN_URL + 'jobtype/load_data',
		method: 'post',
		data: { id: id },
		success: function( data ) {
			UnBlock();
			$( '#tbody' ).prepend( '<tr id="row_id_' + id + '">' + tmpl( 'load_row', data.rows ) + '</tr>' );
		}
	} );
}